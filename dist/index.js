function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var r=t(require("bottlejs")),e=t(require("@wonderlandlabs/propper")),o=require("rxjs");require("url-join");var n=t(require("axios"));require("@wonderlandlabs/looking-glass-engine");var i=require("rxjs/operators"),s=t(require("lodash.get")),a=t(require("uuid/v4")),u=function(){var t=new r;return function(t){t.factory("UNSET",function(t){return(0,t.Symbol)("UNSET")}),t.factory("ifUnset",function(t){var r=t.UNSET;return function(t,e){return t===r||void 0===t?e:t}}),t.factory("isUnset",function(t){var r=t.UNSET;return function(t){return t===r}}),t.factory("Symbol",function(t){return function(t){return{name:t}}}),t.factory("error",function(){return function(t,r){var e=new Error(t);return r?Object.assign(e,{info:r}):e}})}(t),function(t){t.factory("Vector",function(t){var r=t.UNSET,o=t.Impulse,n=t.error,a=t.noop,u=t.isUnset,c=function(t,e){void 0===e&&(e={}),this.pool=s(e,"pool"),this.sender=s(e,"sender"),this.config=s(e,"config",e),this.schema=s(e,"schema"),this._impulseFilter=s(e,"impulseFilter",r),this._paramsToQuery=s(e,"paramsToQuery",a),this.name=t},p={signalStream:{configurable:!0}};return c.prototype.impulse=function(t){return void 0===t&&(t={}),new o({vector:this,params:t})},c.prototype.paramsToQuery=function(t){return this._paramsToQuery(t.params,t,this)},c.prototype.send=function(t){try{var r=this;return function(e,o){try{var n=Promise.resolve(r.sender(t.query,t)).then(function(r){return t.response=r,Promise.resolve(t)})}catch(t){return o(t)}return n&&n.then?n.then(void 0,o):n}(0,function(r){return t.error=r,Promise.reject(t)})}catch(t){return Promise.reject(t)}},c.prototype.impulseFilter=function(t){return u(this._impulseFilter)?function(r){return r.impulse===t}:(console.log("using _impulseFilter",this.impulseFilter),this._impulseFilter(t,this))},p.signalStream.get=function(){var t=this;return this._signalStream||(this._signalStream=this.pool.signalStream.pipe(i.filter(function(r){return r.vector.name===t.name}))),this._signalStream},c.prototype.subscribe=function(){for(var t,r=[],e=arguments.length;e--;)r[e]=arguments[e];return(t=this.signalStream).subscribe.apply(t,r)},Object.defineProperties(c.prototype,p),e(c).addProp("pool",{required:!0,type:"object",onInvalid:function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];throw n("bad vector.pool",{field:"config",object:"Pool",params:t})}}).addProp("sender",{required:!0,type:"function",onInvalid:function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];throw n("bad vector.sender",{field:"config",object:"Pool",params:t})}}).addProp("schema").addProp("config",{type:"object",onInvalid:function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];throw n("bad vector.config",{field:"config",object:"Pool",params:t})}}).addProp("name",{required:!0,type:"string",onInvalid:function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];throw n("bad vector.name",{field:"config",object:"Pool",params:t})}}),c})}(t),function(t){t.factory("Pool",function(t){var r=t.Vector,n=t.error,i=function(t,r){void 0===r&&(r={}),this.name=t,this.vectors=s(r,"_vectors",new Map),this.config=s(r,"config",r)},a={signalStream:{configurable:!0}};return i.prototype.addVector=function(t,e,o){if(void 0===o&&(o=!1),this.vectors.has(t)&&!o)throw n("Attempt to redefine "+t,{config:e,name:t,pool:this});return e instanceof r?(e.pool=this,this.vectors.set(t,e)):this.vectors.set(t,new r(t,"function"==typeof e?{pool:this,sender:e}:Object.assign({},e,{pool:this},e))),this},i.prototype.impulse=function(t,r){if(!this.vectors.has(t))throw n("attempt to use an unregistered vector",{pool:this,name:t,params:r});return this.vectors.get(t).impulse(r)},a.signalStream.get=function(){return this._signalStream||(this._signalStream=new o.Subject),this._signalStream},i.prototype.subscribe=function(){for(var t,r=[],e=arguments.length;e--;)r[e]=arguments[e];return(t=this.signalStream).subscribe.apply(t,r)},Object.defineProperties(i.prototype,a),e(i).addProp("vectors",{defaultValue:function(){return new Map}}).addProp("name",{type:"string",required:!0}).addProp("config",{type:"object",defaultValue:function(){return{}},onInvalid:function(){for(var t=[],r=arguments.length;r--;)t[r]=arguments[r];throw n("bad pool.config",{field:"config",object:"Pool",params:t})}}),i})}(t),function(t){t.constant("noop",function(t){return t});var r=function(t){return{error:t,defaultCatcher:!0}};t.factory("rxCatch",function(t){var e=t.noop;return function(t,n,s){return void 0===n&&(n=e),void 0===s&&(s=r),t.pipe(i.switchMap(function(t){return o.of(t).pipe(i.map(n),i.catchError(function(t){return o.of(s(t))}))}))}})}(t),function(t){t.factory("IMPULSE_STATE_NEW",function(t){return(0,t.Symbol)("IMPULSE_STATE_NEW")}),t.factory("IMPULSE_STATE_QUEUED",function(t){return(0,t.Symbol)("IMPULSE_STATE_QUEUED")}),t.factory("IMPULSE_STATE_SENT",function(t){return(0,t.Symbol)("IMPULSE_STATE_SENT")}),t.factory("IMPULSE_STATE_RESOLVED",function(t){return(0,t.Symbol)("IMPULSE_STATE_RESOLVED")}),t.factory("IMPULSE_STATE_UPDATED",function(t){return(0,t.Symbol)("IMPULSE_STATE_UPDATED")}),t.factory("IMPULSE_STATE_ERROR",function(t){return(0,t.Symbol)("IMPULSE_STATE_ERROR")}),t.factory("IMPULSE_STATE_COMPLETE",function(t){return(0,t.Symbol)("IMPULSE_STATE_COMPLETE")}),t.factory("Impulse",function(t){var r=t.error,o=t.Signal,n=function(t){void 0===t&&(t={}),this.vector=s(t,"vector"),this._params=s(t,"params",t)},a={params:{configurable:!0},pool:{configurable:!0},signalStream:{configurable:!0}};return a.params.get=function(){return this._params},a.pool.get=function(){return this.vector.pool},n.prototype.send=function(){var t=this,r=new o(this);return this.vector.send(r).then(function(){t.pool.signalStream.next(r)}).catch(function(){t.pool.signalStream.error(r)})},a.signalStream.get=function(){return this._signalStream||(this._signalStream=this.vector.signalStream.pipe(i.filter(this.vector.impulseFilter(this)))),this._signalStream},n.prototype.subscribe=function(){for(var t,r=[],e=arguments.length;e--;)r[e]=arguments[e];return(t=this.signalStream).subscribe.apply(t,r)},Object.defineProperties(n.prototype,a),e(n).addProp("vector",{required:!0,type:"object",onInvalid:function(t){throw r("bad impulse.config",{field:"vector",object:"Impulse",err:t})}}),n})}(t),function(t){t.factory("Promiser",function(t){return function(){function t(){var t=this;this._resolved=!1,this.promise=new Promise(function(r,e){t._done=r,t._fail=e})}var r={resolved:{configurable:!0}};return r.resolved.get=function(){return this._resolved},t.prototype.resolve=function(t){return this.resolved?this.promise:(this.response=t,this._resolved=!0,this._done(t),this.promise)},t.prototype.reject=function(t){return this.resolved?this.promise:(this._resolved=!0,this.error=t,this._fail(this),this.promise)},t.prototype.then=function(){for(var t,r=[],e=arguments.length;e--;)r[e]=arguments[e];return(t=this.promise).then.apply(t,r)},t.prototype.catch=function(t){return this.promise.catch(t)},Object.defineProperties(t.prototype,r),t}()})}(t),function(t){t.factory("RestPool",function(t){return function(t){function r(){t.apply(this,arguments)}return t&&(r.__proto__=t),(r.prototype=Object.create(t&&t.prototype)).constructor=r,r}(t.Pool)})}(t),function(t){t.factory("DataMap",function(){return function(){function t(t,r){var e=this;this._map=new Map,this.pool=r,(Array.isArray(t)?t:[t]).forEach(function(t){e.set(t[r.idField],t)})}var r={size:{configurable:!0}};return r.size.get=function(){return this._map.size},t.prototype.entries=function(){return this._map.entries()},t.prototype.get=function(t){return this._map.get(t)},t.prototype.set=function(){for(var t,r=[],e=arguments.length;e--;)r[e]=arguments[e];return(t=this._map).set.apply(t,r)},t.prototype.has=function(t){return this._map.has(t)},t.prototype.keys=function(){return this._map.keys()},t.prototype.clear=function(){return this._map.clear()},t.prototype.delete=function(t){return this._map.delete(t)},t.prototype.values=function(){return this._map.values()},t.prototype.forEach=function(t){return this._map.forEach(t)},t.prototype.overlaps=function(r){if(!r instanceof t)return!1;if(r.size<this.size)return r.overlaps(this);for(var e=this.keys(),o=e.next();!o.done;){if(r.has(o.value))return!0;o=e.next()}return!1},t.prototype.sharedKeys=function(r){if(!r instanceof t)return!1;if(r.size<this.size)return r.sharedKeys(this);for(var e=this.keys(),o=[],n=e.next();!n.done;)r.has(n.value)&&o.push(n.value),n=e.next();return o},t.prototype.clone=function(){var r=new t([],this.pool);return r.updateFrom(this,!0),r},t.prototype.updateFrom=function(t,r,e){var o=this;return void 0===r&&(r=!1),void 0===e&&(e=!0),t.pool!==this.pool&&console.log(error("attempt to merge data from wrong pool",{map:this,otherMap:t})),t.forEach(function(t,n){if(o.has(n)){var i=e?Object.assign({},o.get(n),t):t;o.set(n,i)}else r&&o.set(n,t)}),this},Object.defineProperties(t.prototype,r),t}()})}(t),function(t){t.constant("REST_ACTIONS","get,put,post,delete,getAll".split(",")),t.factory("axios",function(){return n}),t.factory("observeSingle",function(t){return t.noop}),t.factory("restChannels",function(t){return t.noop}),t.factory("restDataFromImpulse",function(t){return t.noop})}(t),function(t){t.factory("Signal",function(t){return function(){function t(t){this.id=a(),this._impulse=t}var r={pool:{configurable:!0},impulse:{configurable:!0},vector:{configurable:!0},params:{configurable:!0},query:{configurable:!0}};return t.prototype.toJSON=function(){return{id:this.id,pool:this.pool.name,vector:this.vector.name,query:JSON.stringify(this.query)}},r.pool.get=function(){return this.impulse.pool},r.impulse.get=function(){return this._impulse},r.vector.get=function(){return this.impulse.vector},r.params.get=function(){return this.impulse.params},r.query.get=function(){return this._query||(this._query=this.vector.paramsToQuery(this.impulse)),this._query},Object.defineProperties(t.prototype,r),t}()})}(t),t},c=u().container,p=c.Pool,f=c.RestPool,l=c.Vector,h=c.Impulse,m=c.DataMap,d=c.axios,y={Pool:p,RestPool:f,Vector:l,Impulse:h,DataMap:m,bottle:u,axios:d};exports.Pool=p,exports.RestPool=f,exports.Vector=l,exports.Impulse=h,exports.bottle=u,exports.DataMap=m,exports.axios=d,exports.default=y;
//# sourceMappingURL=index.js.map
