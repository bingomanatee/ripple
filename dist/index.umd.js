!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("bottlejs"),require("rxjs"),require("@wonderlandlabs/looking-glass-engine"),require("url-join"),require("@wonderlandlabs/propper"),require("axios"),require("rxjs/operators"),require("lodash.get"),require("uuid/v4")):"function"==typeof define&&define.amd?define(["exports","bottlejs","rxjs","@wonderlandlabs/looking-glass-engine","url-join","@wonderlandlabs/propper","axios","rxjs/operators","lodash.get","uuid/v4"],e):e(t.ripple={},t.bottlejs,t.rxjs,0,t.urlJoin,t.propper,t.axios,t.operators,t.lGet,t.uuid)}(this,function(t,e,r,n,o,i,s,a,u,c){e=e&&e.hasOwnProperty("default")?e.default:e,o=o&&o.hasOwnProperty("default")?o.default:o,i=i&&i.hasOwnProperty("default")?i.default:i,s=s&&s.hasOwnProperty("default")?s.default:s,u=u&&u.hasOwnProperty("default")?u.default:u,c=c&&c.hasOwnProperty("default")?c.default:c;var p=function(t){return encodeURIComponent(t).replace(/[!'()*]/g,function(t){return"%"+t.charCodeAt(0).toString(16).toUpperCase()})},l=Object.getOwnPropertySymbols,f=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,d=function(){try{if(!Object.assign)return!1;var t=new String("abc");if(t[5]="de","5"===Object.getOwnPropertyNames(t)[0])return!1;for(var e={},r=0;r<10;r++)e["_"+String.fromCharCode(r)]=r;if("0123456789"!==Object.getOwnPropertyNames(e).map(function(t){return e[t]}).join(""))return!1;var n={};return"abcdefghijklmnopqrst".split("").forEach(function(t){n[t]=t}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},n)).join("")}catch(t){return!1}}()?Object.assign:function(t,e){for(var r,n,o=function(t){if(null==t)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(t)}(t),i=1;i<arguments.length;i++){for(var s in r=Object(arguments[i]))f.call(r,s)&&(o[s]=r[s]);if(l){n=l(r);for(var a=0;a<n.length;a++)h.call(r,n[a])&&(o[n[a]]=r[n[a]])}}return o};function m(t,e){return e.encode?e.strict?p(t):encodeURIComponent(t):t}new RegExp("%[a-f0-9]{2}","gi"),new RegExp("(%[a-f0-9]{2})+","gi");var y=function(){var t=new e;return function(t){t.factory("UNSET",function(t){return(0,t.Symbol)("UNSET")}),t.factory("ifUnset",function(t){var e=t.UNSET;return function(t,r){return t===e||void 0===t?r:t}}),t.factory("isUnset",function(t){var e=t.UNSET;return function(t){return t===e}}),t.factory("Symbol",function(t){return function(t){return{name:t}}}),t.factory("error",function(){return function(t,e){var r=new Error(t);return e?Object.assign(r,{info:e}):r}})}(t),function(t){t.factory("Vector",function(t){var e=t.UNSET,r=t.Impulse,n=t.error,o=t.noop,s=t.isUnset,c=function(t,r){void 0===r&&(r={}),this.pool=u(r,"pool"),this.sender=u(r,"sender"),this.config=u(r,"config",r),this.schema=u(r,"schema"),this._impulseFilter=u(r,"impulseFilter",e),this._impulseMap=u(r,"impulseMap",e),this._paramsToQuery=u(r,"paramsToQuery",o),this.idempotent=u(r,"idempotent",!1),this.name=t},p={signalStream:{configurable:!0}};return c.prototype.impulse=function(t){return void 0===t&&(t={}),new r({vector:this,params:t})},c.prototype.paramsToQuery=function(t){return this._paramsToQuery(t.params,t,this)},c.prototype.send=function(t){try{var e=this;return function(r,n){try{var o=Promise.resolve(e.sender(t.query,t)).then(function(e){return t.response=e,Promise.resolve(t)})}catch(t){return n(t)}return o&&o.then?o.then(void 0,n):o}(0,function(e){return t.error=e,Promise.reject(t)})}catch(t){return Promise.reject(t)}},c.prototype.impulseFilter=function(t){var e=t.id;return s(this._impulseFilter)?function(t){return t.impulse.id===e}:this._impulseFilter(t,this)},c.prototype.impulseMap=function(t){return s(this._impulseMap)?o:this._impulseMap(t,this)},p.signalStream.get=function(){var t=this;return this._signalStream||(this._signalStream=this.pool.signalStream.pipe(a.filter(function(e){return e.vector.name===t.name}))),this._signalStream},c.prototype.subscribe=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this.signalStream).subscribe.apply(t,e)},Object.defineProperties(c.prototype,p),i(c).addProp("idempotent",{type:"boolean",defaultValue:!1}).addProp("pool",{required:!0,type:"object",onInvalid:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];throw n("bad vector.pool",{field:"config",object:"Pool",params:t})}}).addProp("sender",{required:!0,type:"function",onInvalid:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];throw n("bad vector.sender",{field:"config",object:"Pool",params:t})}}).addProp("schema").addProp("config",{type:"object",onInvalid:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];throw n("bad vector.config",{field:"config",object:"Pool",params:t})}}).addProp("name",{required:!0,type:"string",onInvalid:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];throw n("bad vector.name",{field:"config",object:"Pool",params:t})}}),c})}(t),function(t){t.factory("Pool",function(t){var e=t.Vector,n=t.error,o=function(t,e){void 0===e&&(e={}),this.name=t,this.vectors=u(e,"_vectors",new Map),this.config=u(e,"config",e)},s={signalStream:{configurable:!0}};return o.prototype.addVector=function(t,r,o){if(void 0===o&&(o=!1),this.vectors.has(t)&&!o)throw n("Attempt to redefine "+t,{config:r,name:t,pool:this});return r instanceof e?(r.pool=this,this.vectors.set(t,r)):this.vectors.set(t,new e(t,"function"==typeof r?{pool:this,sender:r}:Object.assign({},r,{pool:this},r))),this},o.prototype.impulse=function(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];if(!this.vectors.has(t))throw n("attempt to use an unregistered vector",{pool:this,name:t,params:e});return this.vectors.get(t).impulse(e)},s.signalStream.get=function(){return this._signalStream||(this._signalStream=new r.Subject),this._signalStream},o.prototype.subscribe=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this.signalStream).subscribe.apply(t,e)},Object.defineProperties(o.prototype,s),i(o).addProp("vectors",{defaultValue:function(){return new Map}}).addProp("name",{type:"string",required:!0}).addProp("config",{type:"object",defaultValue:function(){return{}},onInvalid:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];throw n("bad pool.config",{field:"config",object:"Pool",params:t})}}),o})}(t),function(t){t.constant("noop",function(t){return t});var e=function(t){return{error:t,defaultCatcher:!0}};t.factory("rxCatch",function(t){var n=t.noop;return function(t,o,i){return void 0===o&&(o=n),void 0===i&&(i=e),t.pipe(a.switchMap(function(t){return r.of(t).pipe(a.map(o),a.catchError(function(t){return r.of(i(t))}))}))}})}(t),function(t){t.factory("IMPULSE_STATE_NEW",function(t){return(0,t.Symbol)("IMPULSE_STATE_NEW")}),t.factory("IMPULSE_STATE_QUEUED",function(t){return(0,t.Symbol)("IMPULSE_STATE_QUEUED")}),t.factory("IMPULSE_STATE_SENT",function(t){return(0,t.Symbol)("IMPULSE_STATE_SENT")}),t.factory("IMPULSE_STATE_RESOLVED",function(t){return(0,t.Symbol)("IMPULSE_STATE_RESOLVED")}),t.factory("IMPULSE_STATE_UPDATED",function(t){return(0,t.Symbol)("IMPULSE_STATE_UPDATED")}),t.factory("IMPULSE_STATE_ERROR",function(t){return(0,t.Symbol)("IMPULSE_STATE_ERROR")}),t.factory("IMPULSE_STATE_COMPLETE",function(t){return(0,t.Symbol)("IMPULSE_STATE_COMPLETE")}),t.factory("Impulse",function(t){var e=t.error,r=t.Signal,n=function(t){void 0===t&&(t={}),this.id=c(),this.vector=u(t,"vector"),this.params=u(t,"params",t)},o={pool:{configurable:!0},signalStream:{configurable:!0},_subs:{configurable:!0}};return o.pool.get=function(){return this.vector.pool},n.prototype.send=function(){var t=this;if(this._pending)return this.vector.idempotent?this._pending:this._pending.then(function(){return t.send()}).catch(function(){return t.send()});var e=new r(this);return this._pending=this.vector.send(e).then(function(){return t._pending=!1,t.pool.signalStream.next(e),e}).catch(function(){return t._pending=!1,t.pool.signalStream.error(e),e}),this._pending},o.signalStream.get=function(){return this._signalStream||(this._signalStream=this.vector.signalStream.pipe(a.filter(this.vector.impulseFilter(this),a.map(this.vector.impulseMap(this))))),this._signalStream},n.prototype.subscribe=function(){for(var t,r=[],n=arguments.length;n--;)r[n]=arguments[n];if(this._completed)throw e("cannot subscribe to completed impulse",{impulse:this,params:r});var o=(t=this.signalStream).subscribe.apply(t,r);return this._subs.push(o),o},o._subs.get=function(){return this.__subs||(this.__subs=[]),this.__subs},n.prototype.complete=function(){this._completed=!0,this._signalStream&&this._signalStream.complete(),this.__subs&&this.__subs.forEach(function(t){return t.unsubscribe()}),delete this.__subs},Object.defineProperties(n.prototype,o),i(n).addProp("params",{type:"array",required:!0}).addProp("vector",{required:!0,type:"object",onInvalid:function(t){throw e("bad impulse.config",{field:"vector",object:"Impulse",err:t})}}),n})}(t),function(t){t.factory("Promiser",function(t){return function(){function t(){var t=this;this._resolved=!1,this.promise=new Promise(function(e,r){t._done=e,t._fail=r})}var e={resolved:{configurable:!0}};return e.resolved.get=function(){return this._resolved},t.prototype.resolve=function(t){return this.resolved?this.promise:(this.response=t,this._resolved=!0,this._done(t),this.promise)},t.prototype.reject=function(t){return this.resolved?this.promise:(this._resolved=!0,this.error=t,this._fail(this),this.promise)},t.prototype.then=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this.promise).then.apply(t,e)},t.prototype.catch=function(t){return this.promise.catch(t)},Object.defineProperties(t.prototype,e),t}()})}(t),function(t){t.factory("RestPool",function(t){var e=t.error,r=t.isUnset,n=t.noop,s=t.axios,a=t.REST_ACTIONS,c=t.UNSET,p=t.restVectors,l=t.impulseParamsToQuery,f=function(t){function i(o,i){var f=this;t.call(this,o,i),this.baseURL=u(i,"baseURL","/"),this.prepQuery=u(i,"prepQuery",null),this.identityField=u(i,"identityField","id"),this.responseToData=u(i,"responseToData",n),this.dataToClass=u(i,"dataToClass",n),this.connection=u(i,"connection",s),this.impulseParamsToQuery=u(i,"impulseParamsToQuery",l);var h=u(i,"restActions",c);r(h)?a.forEach(function(t){f.addVector(t,p[t])}):h.forEach(function(t){if("string"==typeof t)f.addVector(t,p[t]);else{if(!Array.isArray(t))throw e("strange action for pool "+o,{action:t});f.addVector(t[0],t[1])}})}return t&&(i.__proto__=t),(i.prototype=Object.create(t&&t.prototype)).constructor=i,i.prototype.url=function(t,e){var r=o(this.baseURL,t);return e&&(r+="?"+function(t,e){!1===(e=d({encode:!0,strict:!0,arrayFormat:"none"},e)).sort&&(e.sort=function(){});var r=function(t){switch(t.arrayFormat){case"index":return function(e,r,n){return null===r?[m(e,t),"[",n,"]"].join(""):[m(e,t),"[",m(n,t),"]=",m(r,t)].join("")};case"bracket":return function(e,r){return null===r?m(e,t):[m(e,t),"[]=",m(r,t)].join("")};default:return function(e,r){return null===r?m(e,t):[m(e,t),"=",m(r,t)].join("")}}}(e);return t?Object.keys(t).sort(e.sort).map(function(n){var o=t[n];if(void 0===o)return"";if(null===o)return m(n,e);if(Array.isArray(o)){var i=[];return o.slice().forEach(function(t){void 0!==t&&i.push(r(n,t,i.length))}),i.join("&")}return m(n,e)+"="+m(o,e)}).filter(function(t){return t.length>0}).join("&"):""}(e)),r},i}(t.Pool);return i(f).addProp("identityField",{type:"string",required:!0,defaultValue:"id"}).addProp("responseToData",{type:"function",defaultValue:function(){return n},required:!0}).addProp("prepQuery",{type:"function",defaultValue:function(){return n},required:!1}).addProp("dataToClass",{type:"function",defaultValue:function(){return n}}).addProp("baseURL",{type:"string",defaultValue:"/",required:!0,test:[function(t){return"/"===t||/$http(s)?:\/\/.+/.test(t)},!1,"badly formed URL"]}),f})}(t),function(t){t.factory("DataMap",function(){return function(){function t(t,e){var r=this;this._map=new Map,this.pool=e,(Array.isArray(t)?t:[t]).forEach(function(t){r.set(t[e.idField],t)})}var e={size:{configurable:!0}};return e.size.get=function(){return this._map.size},t.prototype.entries=function(){return this._map.entries()},t.prototype.get=function(t){return this._map.get(t)},t.prototype.set=function(){for(var t,e=[],r=arguments.length;r--;)e[r]=arguments[r];return(t=this._map).set.apply(t,e)},t.prototype.has=function(t){return this._map.has(t)},t.prototype.keys=function(){return this._map.keys()},t.prototype.clear=function(){return this._map.clear()},t.prototype.delete=function(t){return this._map.delete(t)},t.prototype.values=function(){return this._map.values()},t.prototype.forEach=function(t){return this._map.forEach(t)},t.prototype.overlaps=function(e){if(!e instanceof t)return!1;if(e.size<this.size)return e.overlaps(this);for(var r=this.keys(),n=r.next();!n.done;){if(e.has(n.value))return!0;n=r.next()}return!1},t.prototype.sharedKeys=function(e){if(!e instanceof t)return!1;if(e.size<this.size)return e.sharedKeys(this);for(var r=this.keys(),n=[],o=r.next();!o.done;)e.has(o.value)&&n.push(o.value),o=r.next();return n},t.prototype.clone=function(){var e=new t([],this.pool);return e.updateFrom(this,!0),e},t.prototype.updateFrom=function(t,e,r){var n=this;return void 0===e&&(e=!1),void 0===r&&(r=!0),t.pool!==this.pool&&console.log(error("attempt to merge data from wrong pool",{map:this,otherMap:t})),t.forEach(function(t,o){if(n.has(o)){var i=r?Object.assign({},n.get(o),t):t;n.set(o,i)}else e&&n.set(o,t)}),this},Object.defineProperties(t.prototype,e),t}()})}(t),function(t){t.constant("REST_ACTIONS","get,put,post,delete,getAll".split(",")),t.factory("axios",function(){return s}),t.factory("observeSingle",function(t){return t.noop}),t.factory("restChannels",function(t){return t.noop}),t.factory("restDataFromImpulse",function(t){return t.noop})}(t),function(t){t.factory("Signal",function(t){var e=t.UNSET,r=t.isUnset;return function(){function t(t,r){void 0===r&&(r={}),this.id=c(),this.response=u(r,"response",null),this.error=u(r,"error",null),this._baseSignal=u(r,"baseSignal",e),this._impulse=t}var n={baseSignal:{configurable:!0},pool:{configurable:!0},impulse:{configurable:!0},vector:{configurable:!0},params:{configurable:!0},query:{configurable:!0}};return t.prototype.toJSON=function(){var t={id:this.id,pool:this.pool.name,vector:this.vector.name,query:JSON.stringify(this.query),error:u(this,"error",null),response:u(this,"response",null),impulseId:this.impulse.id};return r(this._baseSignal)||(t.baseSignal=this._baseSignal.toJSON()),t},t.prototype.mutate=function(e){return new t(this.impulse,Object.assign({},e,{baseSignal:this}))},n.baseSignal.get=function(){return this._baseSignal},n.pool.get=function(){return this.impulse.pool},n.impulse.get=function(){return this._impulse},n.vector.get=function(){return this.impulse.vector},n.params.get=function(){return this.impulse.params},n.query.get=function(){return this._query||(this._query=this.vector.paramsToQuery(this.impulse)),this._query},Object.defineProperties(t.prototype,n),t}()})}(t),t},g=y().container,v=g.Pool,b=g.RestPool,_=g.Vector,S=g.Impulse,P=g.DataMap,E=g.axios,T={Pool:v,RestPool:b,Vector:_,Impulse:S,DataMap:P,bottle:y,axios:E};t.Pool=v,t.RestPool=b,t.Vector=_,t.Impulse=S,t.bottle=y,t.DataMap=P,t.axios=E,t.default=T});
//# sourceMappingURL=index.umd.js.map
